<!-- 이 예제는 POI (관심 지점)에서 클릭 이벤트 리스너를 사용하는 방법을 보여줍니다. 
    POI 아이콘에서 click 이벤트를 수신 한 다음 길 찾기 서비스 .route 요청과 함께 이벤트 데이터의 placeId를 사용하여 
    클릭 한 장소에 대한 경로를 계산하고 표시합니다. 또한 placeId를 사용하여 장소에 대한 자세한 정보를 얻습니다. -->
<!DOCTYPE html>
<html>

<head>
    <title>main</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <style>
        /* Always set the map height explicitly to define the size of the div
           * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .title {
            font-weight: bold;
        }

        #infowindow-content {
            display: none;
        }

        #map #infowindow-content {
            display: inline;
        }


        #sideNav {
            /* text-align: center; */
            position: fixed;
            top: 0;
            left: 0;
            display: block;
            width: 17rem;
            height: 100vh;
        }

        #sideNav .navbar-nav .nav-item .nav-link {
            font-weight: 800;
            letter-spacing: 0.05rem;
            text-transform: uppercase;
        }

        #sideNav .navbar-brand .img-profile {
            max-width: 4rem;
            max-height: 4rem;
            border: 0.5rem solid rgba(255, 255, 255, 0.2);
            margin-left: 10px;
        }

        #sideNav .navbar-collapse {
            display: flex;
            align-items: flex-start;
            flex-grow: 0;
            width: 100%;
            margin-bottom: auto;
        }

        #sideNav .navbar-collapse .navbar-nav {
            flex-direction: column;
            width: 100%;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark fixed-top" id="sideNav" style="background-color: #3b5998;">

        <a class="d-flex justify-content-center navbar-brand js-scroll-trigger" href="#page-top"
            style="margin-right:0;">
            <!-- <span class="d-lg-none"></span> -->
            <h3 class="mt-3">Google Maps </h3>
        </a>

        <div class="navbar-collapse mt-3">
            <ul class="navbar-nav nav-item">
                <li class="d-flex nav-item mx-auto">
                    <a class="nav-link js-scroll-trigger mb-2 mr-3" href="#">위&nbsp치</a>
                    <input type="text" id="location_index" class="form-control" style="width:180px;" value="">
                </li>
                <li class="d-flex nav-item mx-auto">
                    <a class="nav-link js-scroll-trigger mb-2 mr-3" href="#">위&nbsp도</a>
                    <input type="text" id="lat" class="form-control" style="width:180px;" value="">
                </li>
                <li class="d-flex nav-item mx-auto">
                    <a class="nav-link js-scroll-trigger mb-2  mr-3" href="#">경&nbsp도</a>
                    <input type="text" id="lng" class="form-control" style="width:180px;" value="">
                </li>
                <li class="nav-item mx-auto mt-3">
                    <a class="d-flex justify-content-center navbar-brand js-scroll-trigger" href="#page-top"
                        style="margin-right:0;">
                        <h5 class="mt-3">직선 거리 계산</h5>
                    </a>
                    <div class="d-flex">
                        <a class="nav-link js-scroll-trigger mb-2 mr-3" href="#">출발</a>
                        <input type="text" id="start_index" class="form-control" style="width:180px;" value=""
                            placeholder="위치입력">
                    </div>
                    <div class="d-flex">
                        <a class="nav-link js-scroll-trigger mb-2 mr-3" href="#">도착</a>
                        <input type="text" id="end_index" class="form-control" style="width:180px;" value=""
                            placeholder="위치입력">
                    </div>
                    <div class="d-flex">
                        <a class="nav-link js-scroll-trigger mb-2 mr-3" href="#">거리</a>
                        <input type="text" id="distance" class="form-control" style="width:180px;" value=""
                            placeholder="">
                    </div>
                    <div class="text-center">
                        <button id="dis_cal" class="btn btn-primary" type="submit" style="width:70px;">계산</button>
                    </div>
                </li>

            </ul>
        </div>

        <div id="" class="text-center mt-3">
            <input onclick="showMarkers();" type=button value="Show All Markers" class="btn btn-success mb-2">
            <input onclick="clearMarkers();" type=button value="Hide Markers" class="btn btn-secondary mb-2">
            <input onclick="deleteMarkers();" type=button value="Delete Markers" class="btn btn-danger mb-2">
            <input onclick="burgerMarkers();" type=button value="강남 햄버거집" class="btn btn-primary mb-2">
        </div>

    </nav> <!-- nav -->

    <div id="map" style="margin-left:272px;"></div>
</body>

<script>

    var input_lat = document.getElementById("lat");
    var input_lng = document.getElementById("lng");
    var start_index = document.getElementById("start_index");
    var end_index = document.getElementById("end_index");
    var location_index = document.getElementById("location_index");
    var distance = document.getElementById("distance");

    var map; //지도 정보
    var markerArray = { //위치 선택시 들어갈 JSON
        "array": [

        ]
    }
    var markerInfo = []; //마크 정보
    var polylineInfo = []; //선 정보
    var burgerInfo = []; //햄버거 정보
    var index = 0;

    var locations = [
        { place: '맘스터치', lat: 37.501625, lng: 127.026849 },
        { place: '버거킹', lat: 37.498872, lng: 127.027609 },
        { place: '맥도날드', lat: 37.498620, lng: 127.028750 }
    ];

    var image = './image/hamburger.svg';
    function burgerMarkers() {
        for (i = 0; i < locations.length; i++) {
            var marker2 = new google.maps.Marker({
                id: i,
                icon:image,
                position: new google.maps.LatLng(locations[i].lat, locations[i].lng),
                map: map
            });
            var infowindow3 = new google.maps.InfoWindow({
                content: '위치 : ' + locations[i].place + '<br>위도: ' + locations[i].lat +
                    '<br>경도: ' + locations[i].lng
            });
            infowindow3.open(map, marker2);

            burgerInfo.push(marker2);

        }
        var burgerPath = new google.maps.Polyline({
            path: locations,
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
        });

        burgerPath.setMap(map);
    }

    function initMap() {
        var origin = { lat: 37.503176, lng: 127.024883 };
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: origin
        });
        var clickHandler = new ClickEventHandler(map, origin);
        window.navigator.geolocation.getCurrentPosition(current_position);


        // for (i = 0; i < locations.length; i++) {
        //     marker2 = new google.maps.Marker({
        //         id: i,
        //         position: new google.maps.LatLng(locations[i][1], locations[i][2]),
        //         map: map
        //     });
        // }
    }

    function current_position(position) {
        var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

        var map_options = {
            center: latlng, zoom: 18,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            mapTypeControl: false,
            navigationControlOptions: { style: google.maps.NavigationControlStyle.SMALL }
        }

        var marker = new google.maps.Marker({
            position: latlng,
            map: map,
            title: "You are here!"
        });
        var infowindow = new google.maps.InfoWindow({
            content: '현재위치' + '<br>위도 : ' + marker.position.lat() + '<br>경도 : ' + marker.position.lng()
        });
        infowindow.open(map, marker);

        marker.addListener('click', function () {
            var infowindow = new google.maps.InfoWindow({
                content: '현재위치' + '<br>위도 : ' + marker.position.lat() + '<br>경도 : ' + marker.position.lng()
            });
            infowindow.open(map, marker);
        }); //정보창 다시 뜸

    }


    var ClickEventHandler = function (map, origin) {
        this.origin = origin;
        this.map = map;
        this.map.addListener('click', this.handleClick.bind(this));
    };

    ClickEventHandler.prototype.handleClick = function (event) {
        placeMarker(map, event.latLng);
        // console.log('You clicked on: ' + event.latLng);
        location_index.value = markerArray.array[index].index;
        input_lat.value = event.latLng.lat();
        input_lng.value = event.latLng.lng();
        // console.log('lat : ' + event.latLng.lat());
        // console.log('lng : ' + event.latLng.lng());
        index += 1;
    }



    function placeMarker(map, location) {
        var marker = new google.maps.Marker({
            position: location,
            map: map,
            index: index,
            icon: {
                url: "https://dev.w3.org/SVG/tools/svgweb/samples/svg-files/wireless.svg",
                scaledSize: new google.maps.Size(50, 50)
            },
            draggable: true,
            animation: google.maps.Animation.DROP
        });

        markerInfo.push(marker);
        markerArray.array.push(
            { "index": index, "lat": location.lat(), "lng": location.lng() }
        );
        // console.log(markerArray.array[0]);
        // console.log(markerArray.array[1]);

        var infowindow = new google.maps.InfoWindow({
            content: '위치 : ' + index + '<br>위도: ' + location.lat() +
                '<br>경도: ' + location.lng()
        });
        infowindow.open(map, marker);
        // marker.addListener('click', toggleBounce);
        marker.addListener('click', function () {
            // var real_index;
            // for (var i = 0; i < markerArray.array.length; i++) {
            //     if (location.lat()) {

            //     }
            // }

            var infowindow = new google.maps.InfoWindow({
                content: '위치 : ' + marker.index + '<br>위도: ' + location.lat() +
                    '<br>경도: ' + location.lng()
            });
            infowindow.open(map, marker);
        }); //정보창 다시 뜸
        // marker.addListener('blur', toggleBounce);

        marker.addListener('dblclick', function () { //마우스 더블클릭시 삭제하기
            markerInfo[marker.index].setMap(null);
        })
    } //placeMarker()_end


    // function toggleBounce() {
    //     if (marker.getAnimation() !== null) {
    //         marker.setAnimation(null);
    //     } else {
    //         marker.setAnimation(google.maps.Animation.BOUNCE);
    //     }
    // }


    var dis_flag = { "start_flag": false, "end_flag": false };
    var dis_start = [] //순서 위도, 경도
    var dis_end = [] //순서 위도, 경도
    document.getElementById("dis_cal").onclick = function () { // button click
        console.log(start_index.value);
        console.log(end_index.value);

        // var start_lat;
        // var end_lat;
        // var start_lng;
        // var end_lng;

        if (markerArray.array.length > 1) {
            for (var i = 0; i < markerArray.array.length; i++) {
                if (markerArray.array[i].index == start_index.value) {
                    dis_flag.start_flag = true;
                    dis_start[0] = markerArray.array[i].lat;
                    dis_start[1] = markerArray.array[i].lng;
                    break;
                }
            }

            for (var j = 0; j < markerArray.array.length; j++) {
                if (markerArray.array[j].index == end_index.value) {
                    dis_flag.end_flag = true;
                    dis_end[0] = markerArray.array[j].lat;
                    dis_end[1] = markerArray.array[j].lng;
                    break;
                }
            }

            if (dis_flag.start_flag == true && dis_flag.end_flag == true) {

                var flightPlanCoordinates = [
                    { lat: dis_start[0], lng: dis_start[1] },
                    { lat: dis_end[0], lng: dis_end[1] }
                ];

                var flightPath = new google.maps.Polyline({
                    path: flightPlanCoordinates,
                    geodesic: true,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2
                });
                polylineInfo.push(flightPath);

                flightPath.setMap(map);

            }
        }

        console.log()
        distance.value = calcDistance(dis_start[0], dis_start[1], dis_end[0], dis_end[1])
    }


    function calcDistance(lat1, lon1, lat2, lon2) { //직선 거리 계산 공식
        var EARTH_R, Rad, radLat1, radLat2, radDist;
        var distance, ret;

        EARTH_R = 6371000.0;
        Rad = Math.PI / 180;
        radLat1 = Rad * lat1;
        radLat2 = Rad * lat2;
        radDist = Rad * (lon1 - lon2);

        distance = Math.sin(radLat1) * Math.sin(radLat2);
        distance = distance + Math.cos(radLat1) * Math.cos(radLat2) * Math.cos(radDist);
        ret = EARTH_R * Math.acos(distance);

        var rtn = Math.round(Math.round(ret) / 1000);

        if (rtn <= 0) {
            rtn = Math.round(ret) + " m";
        } else {
            rtn = rtn + " km";
        }
        return rtn;
    }


    // Sets the map on all markers in the array.
    function setMapOnAll(map) {
        for (var i = 0; i < markerInfo.length; i++) {
            markerInfo[i].setMap(map);
        }
    }

    // Sets the map on all markers in the array.
    function setMapOnAllPol(map) {
        for (var i = 0; i < polylineInfo.length; i++) {
            polylineInfo[i].setMap(map);
        }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearMarkers() {
        setMapOnAll(null)
        setMapOnAllPol(null)

    }

    // Shows any markers currently in the array.
    function showMarkers() {
        setMapOnAll(map)
        setMapOnAllPol(map)
    }

    // Deletes all markers in the array by removing references to them.
    function deleteMarkers() {
        clearMarkers();
        markerInfo = [];
        polylineInfo = [];
        index = 0;
        markerArray.array = [];
        location_index.value = null;
        input_lat.value = null;
        input_lng.value = null;
    }




</script>
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB967GKjoFZHapwWuYLDfvp3JQssSZzvkE&libraries=places&callback=initMap&sensor=true"
    async defer></script>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>

</html>